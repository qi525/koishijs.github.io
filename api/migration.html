<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从旧版本迁移 | Koishi</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/koishi.png">
    <meta name="description" content="">
    <meta name="theme-color" content="#5546a3">
    
    <link rel="preload" href="/assets/css/0.styles.8731e940.css" as="style"><link rel="preload" href="/assets/js/app.cd7094d9.js" as="script"><link rel="preload" href="/assets/js/2.9ff48064.js" as="script"><link rel="preload" href="/assets/js/9.4a353ef9.js" as="script"><link rel="preload" href="/assets/js/24.087d1361.js" as="script"><link rel="preload" href="/assets/js/5.1ec24116.js" as="script"><link rel="prefetch" href="/assets/js/10.8d0d4c51.js"><link rel="prefetch" href="/assets/js/11.9c87e860.js"><link rel="prefetch" href="/assets/js/12.f46b7af2.js"><link rel="prefetch" href="/assets/js/13.d0502719.js"><link rel="prefetch" href="/assets/js/14.9171b1b4.js"><link rel="prefetch" href="/assets/js/15.d5c9f0e0.js"><link rel="prefetch" href="/assets/js/16.65417a98.js"><link rel="prefetch" href="/assets/js/17.9116f370.js"><link rel="prefetch" href="/assets/js/18.baac99cb.js"><link rel="prefetch" href="/assets/js/19.678723f8.js"><link rel="prefetch" href="/assets/js/20.a5228916.js"><link rel="prefetch" href="/assets/js/21.53cda660.js"><link rel="prefetch" href="/assets/js/22.9e9100e8.js"><link rel="prefetch" href="/assets/js/23.25310c0f.js"><link rel="prefetch" href="/assets/js/25.2f79e408.js"><link rel="prefetch" href="/assets/js/26.9b79ab98.js"><link rel="prefetch" href="/assets/js/27.a7d44d0f.js"><link rel="prefetch" href="/assets/js/28.21f31302.js"><link rel="prefetch" href="/assets/js/29.d5e15f81.js"><link rel="prefetch" href="/assets/js/3.6fe66a2c.js"><link rel="prefetch" href="/assets/js/30.251e6baa.js"><link rel="prefetch" href="/assets/js/31.334484c7.js"><link rel="prefetch" href="/assets/js/32.8f981c6d.js"><link rel="prefetch" href="/assets/js/33.6d310169.js"><link rel="prefetch" href="/assets/js/34.304a8fcd.js"><link rel="prefetch" href="/assets/js/35.b2c1f496.js"><link rel="prefetch" href="/assets/js/36.4b1ae0e5.js"><link rel="prefetch" href="/assets/js/37.8fb6b29b.js"><link rel="prefetch" href="/assets/js/38.36d1e749.js"><link rel="prefetch" href="/assets/js/39.eee30141.js"><link rel="prefetch" href="/assets/js/4.8d41e874.js"><link rel="prefetch" href="/assets/js/40.1b3311ac.js"><link rel="prefetch" href="/assets/js/41.6e54118f.js"><link rel="prefetch" href="/assets/js/42.852c32dd.js"><link rel="prefetch" href="/assets/js/43.bd613188.js"><link rel="prefetch" href="/assets/js/44.e92ac662.js"><link rel="prefetch" href="/assets/js/45.26164691.js"><link rel="prefetch" href="/assets/js/46.a9d18d74.js"><link rel="prefetch" href="/assets/js/47.da16f5d4.js"><link rel="prefetch" href="/assets/js/48.2c33e213.js"><link rel="prefetch" href="/assets/js/49.dd45a410.js"><link rel="prefetch" href="/assets/js/50.ca2af0a0.js"><link rel="prefetch" href="/assets/js/51.3be595bd.js"><link rel="prefetch" href="/assets/js/52.3737ab79.js"><link rel="prefetch" href="/assets/js/53.79425dd4.js"><link rel="prefetch" href="/assets/js/54.d7411943.js"><link rel="prefetch" href="/assets/js/55.0ffc3d14.js"><link rel="prefetch" href="/assets/js/56.86b19261.js"><link rel="prefetch" href="/assets/js/57.9a8409f6.js"><link rel="prefetch" href="/assets/js/58.0b855ac4.js"><link rel="prefetch" href="/assets/js/59.7294007f.js"><link rel="prefetch" href="/assets/js/6.cc3a06ff.js"><link rel="prefetch" href="/assets/js/60.8db2dc8c.js"><link rel="prefetch" href="/assets/js/61.a0f9d125.js"><link rel="prefetch" href="/assets/js/62.7e117980.js"><link rel="prefetch" href="/assets/js/63.055c882a.js"><link rel="prefetch" href="/assets/js/64.72229f83.js"><link rel="prefetch" href="/assets/js/65.2ee92b65.js"><link rel="prefetch" href="/assets/js/66.65269c36.js"><link rel="prefetch" href="/assets/js/67.0dab4039.js"><link rel="prefetch" href="/assets/js/68.6e06140c.js"><link rel="prefetch" href="/assets/js/69.393bca84.js"><link rel="prefetch" href="/assets/js/7.ea3c96e0.js"><link rel="prefetch" href="/assets/js/70.19040ac4.js"><link rel="prefetch" href="/assets/js/71.9e258746.js"><link rel="prefetch" href="/assets/js/8.c9d84004.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8731e940.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/koishi.png" alt="Koishi" class="logo"> <span class="site-name can-hide">Koishi</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/guide/intro/starter.html" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/api/" class="nav-link router-link-active">
  API
</a></div><div class="nav-item"><a href="/plugins/" class="nav-link">
  官方插件
</a></div><div class="nav-item"><a href="https://github.com/koishijs/koishi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/guide/intro/starter.html" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/api/" class="nav-link router-link-active">
  API
</a></div><div class="nav-item"><a href="/plugins/" class="nav-link">
  官方插件
</a></div><div class="nav-item"><a href="https://github.com/koishijs/koishi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/api/" aria-current="page" class="sidebar-link">总览</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>核心 API</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/api/context.html" class="sidebar-link">上下文 (Context)</a></li><li><a href="/api/app.html" class="sidebar-link">应用 (App)</a></li><li><a href="/api/bot.html" class="sidebar-link">机器人 (Bot)</a></li><li><a href="/api/events.html" class="sidebar-link">事件 (Events)</a></li><li><a href="/api/session.html" class="sidebar-link">会话 (Session)</a></li><li><a href="/api/command.html" class="sidebar-link">指令 (Command)</a></li><li><a href="/api/database.html" class="sidebar-link">数据库 (Database)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>其他官方包</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/api/utils.html" class="sidebar-link">常用工具 (Utils)</a></li><li><a href="/api/test-utils.html" class="sidebar-link">测试工具 (Test Utils)</a></li><li><a href="/api/adapter/onebot.html" class="sidebar-link">平台：OneBot</a></li><li><a href="/api/adapter/kaiheila.html" class="sidebar-link">平台：Kaiheila</a></li><li><a href="/api/database/mongo.html" class="sidebar-link">数据库：Mongo</a></li><li><a href="/api/database/mysql.html" class="sidebar-link">数据库：MySQL</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>更新与迁移</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/api/changelog.html" class="sidebar-link">v3 更新日志</a></li><li><a href="/api/migration.html" aria-current="page" class="active sidebar-link">从旧版本迁移</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/api/migration.html#包名变更" class="sidebar-link">包名变更</a></li><li class="sidebar-sub-header"><a href="/api/migration.html#钩子函数" class="sidebar-link">钩子函数</a></li><li class="sidebar-sub-header"><a href="/api/migration.html#选择器" class="sidebar-link">选择器</a></li><li class="sidebar-sub-header"><a href="/api/migration.html#会话接口" class="sidebar-link">会话接口</a></li><li class="sidebar-sub-header"><a href="/api/migration.html#数据库变更" class="sidebar-link">数据库变更</a></li><li class="sidebar-sub-header"><a href="/api/migration.html#单一应用实例" class="sidebar-link">单一应用实例</a></li><li class="sidebar-sub-header"><a href="/api/migration.html#指令选项" class="sidebar-link">指令选项</a></li><li class="sidebar-sub-header"><a href="/api/migration.html#事件名称" class="sidebar-link">事件名称</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="从旧版本迁移"><a href="#从旧版本迁移" class="header-anchor">#</a> 从旧版本迁移</h1> <p>这个页面将介绍 Koishi v3 的新特性和对应的迁移方法。</p> <h2 id="包名变更"><a href="#包名变更" class="header-anchor">#</a> 包名变更</h2> <p>koishi-database-mysql 变更为 koishi-plugin-mysql。</p> <p>此外，你可能还需要额外安装 koishi-adapter-onebot 作为 QQ 平台的支持。</p> <h2 id="钩子函数"><a href="#钩子函数" class="header-anchor">#</a> 钩子函数</h2> <p>Koishi v1 的 <code>ctx.receiver</code> 使用了 <a href="https://nodejs.org/api/events.html#events_class_eventemitter" target="_blank" rel="noopener noreferrer">EventEmitter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来分发事件，而 Koishi v3 则自己实现了一个事件系统。这样做将带来几点好处：</p> <ul><li>使用统一的事件分发机制，无需对每个上下文构造 EventEmitter 实例，具有更高的性能</li> <li><code>emit</code>, <code>parallel</code>, <code>bail</code>, <code>serial</code> 等方法能够妥善处理不同场景下的事件回调</li></ul> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">emit</span><span style="color:#F8F8F2;">()      </span><span style="color:#88846F;">// 同时触发，返回 void</span></span>
<span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">parallel</span><span style="color:#F8F8F2;">()  </span><span style="color:#88846F;">// 同时触发，返回一个全部完成的 Promise</span></span>

<span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">bail</span><span style="color:#F8F8F2;">()      </span><span style="color:#88846F;">// 依次触发，返回第一个 non-nullable 的结果</span></span>
<span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">serial</span><span style="color:#F8F8F2;">()    </span><span style="color:#88846F;">// 依次触发，返回第一个 resolve non-nullable 的结果</span></span></code></pre></div></div><p>相关 API 的迁移方法如下：</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F8F8F2;">ctx.receiver.</span><span style="color:#A6E22E;">on</span><span style="color:#F8F8F2;">(event, callback)    </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  ctx.</span><span style="color:#A6E22E;">on</span><span style="color:#F8F8F2;">(event, callback)</span></span>
<span class="line"><span style="color:#F8F8F2;">ctx.receiver.</span><span style="color:#A6E22E;">emit</span><span style="color:#F8F8F2;">(event, </span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">args)   </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  ctx.</span><span style="color:#A6E22E;">emit</span><span style="color:#F8F8F2;">(event, </span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">args)</span></span>
<span class="line"><span style="color:#F8F8F2;">ctx.app.</span><span style="color:#A6E22E;">emitEvent</span><span style="color:#F8F8F2;">(</span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">args)          </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  ctx.</span><span style="color:#A6E22E;">emit</span><span style="color:#F8F8F2;">(</span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">args)</span></span></code></pre></div></div><h2 id="选择器"><a href="#选择器" class="header-anchor">#</a> 选择器</h2> <p>Koishi v3 提供了选择器，它完全覆盖了 v1 的上下文创建功能并有所增强。</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">user</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">123</span><span style="color:#F8F8F2;">, </span><span style="color:#AE81FF;">456</span><span style="color:#F8F8F2;">)                    </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  ctx.</span><span style="color:#A6E22E;">select</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'userId'</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">'123'</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">'456'</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">ctx.groups.</span><span style="color:#A6E22E;">exclude</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">123</span><span style="color:#F8F8F2;">, </span><span style="color:#AE81FF;">456</span><span style="color:#F8F8F2;">)          </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  ctx.</span><span style="color:#A6E22E;">unselect</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'groupId'</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">'123'</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">'456'</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">ctx.groups.</span><span style="color:#A6E22E;">intersect</span><span style="color:#F8F8F2;">(ctx.</span><span style="color:#A6E22E;">user</span><span style="color:#F8F8F2;">(</span><span style="color:#AE81FF;">789</span><span style="color:#F8F8F2;">))   </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  ctx.</span><span style="color:#A6E22E;">select</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'groupId'</span><span style="color:#F8F8F2;">).</span><span style="color:#A6E22E;">select</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'userId'</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">'789'</span><span style="color:#F8F8F2;">)</span></span></code></pre></div></div><p>相关文档：<a href="/guide/context.html#使用选择器">使用选择器</a></p> <h2 id="会话接口"><a href="#会话接口" class="header-anchor">#</a> 会话接口</h2> <p>Koishi v3 新增了会话的概念，它向下兼容大部分 Koishi v1 元信息对象的特性，并增加了大量方法：</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F8F8F2;">ses.$app              </span><span style="color:#88846F;">// App 实例</span></span>
<span class="line"><span style="color:#F8F8F2;">ses.$bot              </span><span style="color:#88846F;">// Bot 实例</span></span>

<span class="line"><span style="color:#F8F8F2;">ses.</span><span style="color:#A6E22E;">send</span><span style="color:#F8F8F2;">()            </span><span style="color:#88846F;">// 发送消息</span></span>
<span class="line"><span style="color:#F8F8F2;">ses.</span><span style="color:#A6E22E;">sendQueued</span><span style="color:#F8F8F2;">()      </span><span style="color:#88846F;">// 延时发送消息</span></span>
<span class="line"><span style="color:#F8F8F2;">ses.</span><span style="color:#A6E22E;">cancelQueued</span><span style="color:#F8F8F2;">()    </span><span style="color:#88846F;">// 取消延时队列</span></span>

<span class="line"><span style="color:#F8F8F2;">ses.</span><span style="color:#A6E22E;">middleware</span><span style="color:#F8F8F2;">()      </span><span style="color:#88846F;">// 注册仅对当前会话生效的中间件</span></span>
<span class="line"><span style="color:#F8F8F2;">ses.</span><span style="color:#A6E22E;">prompt</span><span style="color:#F8F8F2;">()          </span><span style="color:#88846F;">// 等待一条消息</span></span>
<span class="line"><span style="color:#F8F8F2;">ses.</span><span style="color:#A6E22E;">suggest</span><span style="color:#F8F8F2;">()         </span><span style="color:#88846F;">// 书写错误提示</span></span>

<span class="line"><span style="color:#F8F8F2;">ses.</span><span style="color:#A6E22E;">resolve</span><span style="color:#F8F8F2;">()         </span><span style="color:#88846F;">// 解析 argv 对象</span></span>
<span class="line"><span style="color:#F8F8F2;">ses.</span><span style="color:#A6E22E;">collect</span><span style="color:#F8F8F2;">()         </span><span style="color:#88846F;">// 获取指令所需字段</span></span>
<span class="line"><span style="color:#F8F8F2;">ses.</span><span style="color:#A6E22E;">execute</span><span style="color:#F8F8F2;">()         </span><span style="color:#88846F;">// 执行指令</span></span>

<span class="line"><span style="color:#F8F8F2;">ses.</span><span style="color:#A6E22E;">getUser</span><span style="color:#F8F8F2;">()         </span><span style="color:#88846F;">// 获取用户数据</span></span>
<span class="line"><span style="color:#F8F8F2;">ses.</span><span style="color:#A6E22E;">getChannel</span><span style="color:#F8F8F2;">()      </span><span style="color:#88846F;">// 获取频道数据</span></span>
<span class="line"><span style="color:#F8F8F2;">ses.</span><span style="color:#A6E22E;">observeUser</span><span style="color:#F8F8F2;">()     </span><span style="color:#88846F;">// 绑定可观测用户实例</span></span>
<span class="line"><span style="color:#F8F8F2;">ses.</span><span style="color:#A6E22E;">observeChannel</span><span style="color:#F8F8F2;">()  </span><span style="color:#88846F;">// 绑定可观测频道实例</span></span></code></pre></div></div><p>相关文档：<a href="/guide/message.html#使用会话">使用会话</a></p> <h2 id="数据库变更"><a href="#数据库变更" class="header-anchor">#</a> 数据库变更</h2> <p>Koishi v3 的数据库相比 v1 发生了许多改动，最为显著的一点就是大部分 group 被替换为了 channel：</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#A6E22E;">extendUser</span><span style="color:#F8F8F2;">(callback)        </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  User.</span><span style="color:#A6E22E;">extend</span><span style="color:#F8F8F2;">(callback)</span></span>
<span class="line"><span style="color:#A6E22E;">createUser</span><span style="color:#F8F8F2;">(callback)        </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  User.</span><span style="color:#A6E22E;">create</span><span style="color:#F8F8F2;">(callback)</span></span>
<span class="line"><span style="color:#A6E22E;">extendChannel</span><span style="color:#F8F8F2;">(callback)     </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  Channel.</span><span style="color:#A6E22E;">extend</span><span style="color:#F8F8F2;">(callback)</span></span>
<span class="line"><span style="color:#A6E22E;">createChannel</span><span style="color:#F8F8F2;">(callback)     </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  Channel.</span><span style="color:#A6E22E;">create</span><span style="color:#F8F8F2;">(callback)</span></span>

<span class="line"><span style="color:#F8F8F2;">ctx.db.</span><span style="color:#A6E22E;">getUser</span><span style="color:#F8F8F2;">(</span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">args)     </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  ctx.db.</span><span style="color:#A6E22E;">getUser</span><span style="color:#F8F8F2;">(</span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">args)</span></span>
<span class="line"><span style="color:#F8F8F2;">                            </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  session.</span><span style="color:#A6E22E;">getUser</span><span style="color:#F8F8F2;">(</span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">args)</span></span>
<span class="line"><span style="color:#F8F8F2;">ctx.db.</span><span style="color:#A6E22E;">getGroup</span><span style="color:#F8F8F2;">(</span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">args)    </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  ctx.db.</span><span style="color:#A6E22E;">getChannel</span><span style="color:#F8F8F2;">(</span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">args)</span></span>
<span class="line"><span style="color:#F8F8F2;">                            </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  session.</span><span style="color:#A6E22E;">getChannel</span><span style="color:#F8F8F2;">(</span><span style="color:#F92672;">...</span><span style="color:#F8F8F2;">args)</span></span></code></pre></div></div><p>同时由于 v3 的跨平台特性，你可能还需要留意 <code>database.getUser()</code> 这个接口本身的变化。</p> <p>相关文档：<a href="/guide/database.html">使用数据库</a></p> <h2 id="单一应用实例"><a href="#单一应用实例" class="header-anchor">#</a> 单一应用实例</h2> <p>Koishi v3 使用单一的 App 实例管理多个机器人账号，这将大幅提高程序的启动速度。</p> <p>现在可以通过 <code>ctx.bots</code> 访问当前 App 下的所有机器人，也可以用 <code>session.$app</code> 和 <code>session.$bot</code> 访问当前会话所在的 App 和 Bot 实例了。</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F8F8F2;">appMap[selfId].sender       </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  ctx.bots[selfId]</span></span>
<span class="line"><span style="color:#F8F8F2;">appList.</span><span style="color:#A6E22E;">forEach</span><span style="color:#F8F8F2;">(cb)         </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  ctx.bots.</span><span style="color:#A6E22E;">forEach</span><span style="color:#F8F8F2;">(cb)</span></span>
<span class="line"><span style="color:#F8F8F2;">ctx.sender.</span><span style="color:#A6E22E;">sendGroupMsg</span><span style="color:#F8F8F2;">()   </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  ctx.bots[selfId].</span><span style="color:#A6E22E;">sendMessage</span><span style="color:#F8F8F2;">()</span></span>

<span class="line"><span style="color:#F8F8F2;">appMap[selfId]              </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  session.$app</span></span>
<span class="line"><span style="color:#F8F8F2;">appMap[selfId].sender       </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  session.$bot</span></span>
<span class="line"><span style="color:#F8F8F2;">ctx.sender.</span><span style="color:#A6E22E;">sendGroupMsg</span><span style="color:#F8F8F2;">()   </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  session.$bot.</span><span style="color:#A6E22E;">sendMessage</span><span style="color:#F8F8F2;">()</span></span>

<span class="line"><span style="color:#F8F8F2;">app.selfId                  </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  bot.selfId</span></span>
<span class="line"><span style="color:#A6E22E;">getSelfIds</span><span style="color:#F8F8F2;">()                </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  app.bots.</span><span style="color:#A6E22E;">map</span><span style="color:#F8F8F2;">(</span><span style="color:#FD971F;">bot</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;"> bot.selfId)</span></span></code></pre></div></div><p>同时我们也不再需要全局的生命周期方法了。直接使用 v1 就有的生命周期方法即可控制所有 Bot 实例。</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#A6E22E;">startAll</span><span style="color:#F8F8F2;">()              </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  app.</span><span style="color:#A6E22E;">start</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#A6E22E;">stopAll</span><span style="color:#F8F8F2;">()               </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  app.</span><span style="color:#A6E22E;">stop</span><span style="color:#F8F8F2;">()</span></span>

<span class="line"><span style="color:#A6E22E;">onStart</span><span style="color:#F8F8F2;">(cb)             </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  ctx.</span><span style="color:#A6E22E;">on</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'connect'</span><span style="color:#F8F8F2;">, cb)</span></span>
<span class="line"><span style="color:#A6E22E;">onStop</span><span style="color:#F8F8F2;">(cb)              </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  ctx.</span><span style="color:#A6E22E;">on</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'disconnect'</span><span style="color:#F8F8F2;">, cb)</span></span></code></pre></div></div><p>其他的构造选项变更：</p> <ul><li>commandPrefix -&gt; prefix</li> <li>maxMiddlewares -&gt; maxListeners</li> <li>defaultAuthority -&gt; autoAuthorize</li> <li>quickOperationTimeout -&gt; onebot.quickOperation</li></ul> <h2 id="指令选项"><a href="#指令选项" class="header-anchor">#</a> 指令选项</h2> <p>Koishi v1 的指令系统对 TypeScript 的类型标注并不友好。为了更好地适应强类型和按需获取数据的程序风格，Koishi v3 修改了指令选项的行为：</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">// v1</span></span>
<span class="line"><span style="color:#F8F8F2;">cmd.</span><span style="color:#A6E22E;">option</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'-f, --foo &lt;arg&gt;'</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">'description'</span><span style="color:#F8F8F2;">, { default: </span><span style="color:#AE81FF;">123</span><span style="color:#F8F8F2;"> })</span></span>
<span class="line"><span style="color:#F8F8F2;">cmd.</span><span style="color:#A6E22E;">option</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'-B, --no-bar'</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">'description'</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">cmd.</span><span style="color:#A6E22E;">option</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'--baz &lt;arg&gt;'</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">'description'</span><span style="color:#F8F8F2;">, { isString: </span><span style="color:#AE81FF;">true</span><span style="color:#F8F8F2;"> })</span></span>

<span class="line"><span style="color:#88846F;">// v3</span></span>
<span class="line"><span style="color:#F8F8F2;">cmd.</span><span style="color:#A6E22E;">option</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'foo'</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">'-f &lt;arg&gt; description'</span><span style="color:#F8F8F2;">, { fallback: </span><span style="color:#AE81FF;">123</span><span style="color:#F8F8F2;"> })</span></span>
<span class="line"><span style="color:#F8F8F2;">cmd.</span><span style="color:#A6E22E;">option</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'bar'</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">'-B description'</span><span style="color:#F8F8F2;">, { value: </span><span style="color:#AE81FF;">false</span><span style="color:#F8F8F2;"> })</span></span>
<span class="line"><span style="color:#F8F8F2;">cmd.</span><span style="color:#A6E22E;">option</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'baz'</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">'&lt;arg:string&gt; description'</span><span style="color:#F8F8F2;">)</span></span></code></pre></div></div><p>相关文档：<a href="/guide/command.html#定义选项">定义选项</a></p> <h2 id="事件名称"><a href="#事件名称" class="header-anchor">#</a> 事件名称</h2> <p>为跨平台考虑，Koishi v3 调整了部分事件名称：</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#E6DB74;">'group-recall'</span><span style="color:#F8F8F2;">            </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">'message-deleted/group'</span></span>
<span class="line"><span style="color:#E6DB74;">'friend-recall'</span><span style="color:#F8F8F2;">           </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">'message-deleted/private'</span></span>

<span class="line"><span style="color:#E6DB74;">'friend-add'</span><span style="color:#F8F8F2;">              </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">'friend-added'</span></span>
<span class="line"><span style="color:#E6DB74;">'group-increase'</span><span style="color:#F8F8F2;">          </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">'group-added'</span></span>
<span class="line"><span style="color:#F8F8F2;">                          </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">'group-member-added'</span></span>
<span class="line"><span style="color:#E6DB74;">'group-decrease'</span><span style="color:#F8F8F2;">          </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">'group-deleted'</span></span>
<span class="line"><span style="color:#F8F8F2;">                          </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">'group-member-deleted'</span></span>

<span class="line"><span style="color:#E6DB74;">'group-upload'</span><span style="color:#F8F8F2;">            </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">'group-file-added'</span></span>
<span class="line"><span style="color:#E6DB74;">'group-admin'</span><span style="color:#F8F8F2;">             </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">'group-member/role'</span></span>
<span class="line"><span style="color:#E6DB74;">'group-ban'</span><span style="color:#F8F8F2;">               </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">'group-member/ban'</span></span>

<span class="line"><span style="color:#E6DB74;">'notify/*'</span><span style="color:#F8F8F2;">                </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">'notice/*'</span></span>

<span class="line"><span style="color:#E6DB74;">'request/friend'</span><span style="color:#F8F8F2;">          </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">'friend-request'</span></span>
<span class="line"><span style="color:#E6DB74;">'request/group/invite'</span><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">'group-request'</span></span>
<span class="line"><span style="color:#E6DB74;">'request/group/add'</span><span style="color:#F8F8F2;">       </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">'group-member-request'</span></span>

<span class="line"><span style="color:#E6DB74;">'heartbeat'</span><span style="color:#F8F8F2;">               </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">'lifecycle/heartbeat'</span></span>
<span class="line"><span style="color:#E6DB74;">'lifecycle/*'</span><span style="color:#F8F8F2;">             </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">'lifecycle/*'</span></span></code></pre></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/koishijs/koishijs.github.io/edit/docs/api/migration.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2/4/2021, 9:57:24 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/api/changelog.html" class="prev">
        v3 更新日志
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.cd7094d9.js" defer></script><script src="/assets/js/2.9ff48064.js" defer></script><script src="/assets/js/9.4a353ef9.js" defer></script><script src="/assets/js/24.087d1361.js" defer></script><script src="/assets/js/5.1ec24116.js" defer></script>
  </body>
</html>
