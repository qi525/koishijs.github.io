<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>用户状态管理 | Koishi</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/koishi.png">
    <meta name="description" content="">
    <meta name="theme-color" content="#5546a3">
    
    <link rel="preload" href="/assets/css/0.styles.8731e940.css" as="style"><link rel="preload" href="/assets/js/app.cd7094d9.js" as="script"><link rel="preload" href="/assets/js/2.9ff48064.js" as="script"><link rel="preload" href="/assets/js/9.4a353ef9.js" as="script"><link rel="preload" href="/assets/js/39.eee30141.js" as="script"><link rel="preload" href="/assets/js/5.1ec24116.js" as="script"><link rel="prefetch" href="/assets/js/10.8d0d4c51.js"><link rel="prefetch" href="/assets/js/11.9c87e860.js"><link rel="prefetch" href="/assets/js/12.f46b7af2.js"><link rel="prefetch" href="/assets/js/13.d0502719.js"><link rel="prefetch" href="/assets/js/14.9171b1b4.js"><link rel="prefetch" href="/assets/js/15.d5c9f0e0.js"><link rel="prefetch" href="/assets/js/16.65417a98.js"><link rel="prefetch" href="/assets/js/17.9116f370.js"><link rel="prefetch" href="/assets/js/18.baac99cb.js"><link rel="prefetch" href="/assets/js/19.678723f8.js"><link rel="prefetch" href="/assets/js/20.a5228916.js"><link rel="prefetch" href="/assets/js/21.53cda660.js"><link rel="prefetch" href="/assets/js/22.9e9100e8.js"><link rel="prefetch" href="/assets/js/23.25310c0f.js"><link rel="prefetch" href="/assets/js/24.087d1361.js"><link rel="prefetch" href="/assets/js/25.2f79e408.js"><link rel="prefetch" href="/assets/js/26.9b79ab98.js"><link rel="prefetch" href="/assets/js/27.a7d44d0f.js"><link rel="prefetch" href="/assets/js/28.21f31302.js"><link rel="prefetch" href="/assets/js/29.d5e15f81.js"><link rel="prefetch" href="/assets/js/3.6fe66a2c.js"><link rel="prefetch" href="/assets/js/30.251e6baa.js"><link rel="prefetch" href="/assets/js/31.334484c7.js"><link rel="prefetch" href="/assets/js/32.8f981c6d.js"><link rel="prefetch" href="/assets/js/33.6d310169.js"><link rel="prefetch" href="/assets/js/34.304a8fcd.js"><link rel="prefetch" href="/assets/js/35.b2c1f496.js"><link rel="prefetch" href="/assets/js/36.4b1ae0e5.js"><link rel="prefetch" href="/assets/js/37.8fb6b29b.js"><link rel="prefetch" href="/assets/js/38.36d1e749.js"><link rel="prefetch" href="/assets/js/4.8d41e874.js"><link rel="prefetch" href="/assets/js/40.1b3311ac.js"><link rel="prefetch" href="/assets/js/41.6e54118f.js"><link rel="prefetch" href="/assets/js/42.852c32dd.js"><link rel="prefetch" href="/assets/js/43.bd613188.js"><link rel="prefetch" href="/assets/js/44.e92ac662.js"><link rel="prefetch" href="/assets/js/45.26164691.js"><link rel="prefetch" href="/assets/js/46.a9d18d74.js"><link rel="prefetch" href="/assets/js/47.da16f5d4.js"><link rel="prefetch" href="/assets/js/48.2c33e213.js"><link rel="prefetch" href="/assets/js/49.dd45a410.js"><link rel="prefetch" href="/assets/js/50.ca2af0a0.js"><link rel="prefetch" href="/assets/js/51.3be595bd.js"><link rel="prefetch" href="/assets/js/52.3737ab79.js"><link rel="prefetch" href="/assets/js/53.79425dd4.js"><link rel="prefetch" href="/assets/js/54.d7411943.js"><link rel="prefetch" href="/assets/js/55.0ffc3d14.js"><link rel="prefetch" href="/assets/js/56.86b19261.js"><link rel="prefetch" href="/assets/js/57.9a8409f6.js"><link rel="prefetch" href="/assets/js/58.0b855ac4.js"><link rel="prefetch" href="/assets/js/59.7294007f.js"><link rel="prefetch" href="/assets/js/6.cc3a06ff.js"><link rel="prefetch" href="/assets/js/60.8db2dc8c.js"><link rel="prefetch" href="/assets/js/61.a0f9d125.js"><link rel="prefetch" href="/assets/js/62.7e117980.js"><link rel="prefetch" href="/assets/js/63.055c882a.js"><link rel="prefetch" href="/assets/js/64.72229f83.js"><link rel="prefetch" href="/assets/js/65.2ee92b65.js"><link rel="prefetch" href="/assets/js/66.65269c36.js"><link rel="prefetch" href="/assets/js/67.0dab4039.js"><link rel="prefetch" href="/assets/js/68.6e06140c.js"><link rel="prefetch" href="/assets/js/69.393bca84.js"><link rel="prefetch" href="/assets/js/7.ea3c96e0.js"><link rel="prefetch" href="/assets/js/70.19040ac4.js"><link rel="prefetch" href="/assets/js/71.9e258746.js"><link rel="prefetch" href="/assets/js/8.c9d84004.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8731e940.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/koishi.png" alt="Koishi" class="logo"> <span class="site-name can-hide">Koishi</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/guide/intro/starter.html" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/plugins/" class="nav-link">
  官方插件
</a></div><div class="nav-item"><a href="https://github.com/koishijs/koishi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/guide/intro/starter.html" class="nav-link">
  指南
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  API
</a></div><div class="nav-item"><a href="/plugins/" class="nav-link">
  官方插件
</a></div><div class="nav-item"><a href="https://github.com/koishijs/koishi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>入门</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/intro/about.html" class="sidebar-link">介绍</a></li><li><a href="/guide/intro/starter.html" class="sidebar-link">快速上手</a></li><li><a href="/guide/intro/cli.html" class="sidebar-link">命令行工具</a></li><li><a href="/guide/intro/faq.html" class="sidebar-link">常见问题</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/message.html" class="sidebar-link">接收和发送消息</a></li><li><a href="/guide/context.html" class="sidebar-link">插件与上下文</a></li><li><a href="/guide/command.html" class="sidebar-link">指令系统初探</a></li><li><a href="/guide/execute.html" class="sidebar-link">指令触发机制</a></li><li><a href="/guide/help.html" class="sidebar-link">查看和编写帮助</a></li><li><a href="/guide/manage.html" aria-current="page" class="active sidebar-link">用户状态管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/manage.html#用户系统" class="sidebar-link">用户系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/manage.html#状态标签" class="sidebar-link">状态标签</a></li><li class="sidebar-sub-header"><a href="/guide/manage.html#用户权限" class="sidebar-link">用户权限</a></li><li class="sidebar-sub-header"><a href="/guide/manage.html#平台相关字段" class="sidebar-link">平台相关字段</a></li><li class="sidebar-sub-header"><a href="/guide/manage.html#自动注册数据" class="sidebar-link">自动注册数据</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/manage.html#指令调用管理" class="sidebar-link">指令调用管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/manage.html#设置调用权限" class="sidebar-link">设置调用权限</a></li><li class="sidebar-sub-header"><a href="/guide/manage.html#设置访问次数上限" class="sidebar-link">设置访问次数上限</a></li><li class="sidebar-sub-header"><a href="/guide/manage.html#设置最短触发间隔" class="sidebar-link">设置最短触发间隔</a></li><li class="sidebar-sub-header"><a href="/guide/manage.html#多指令共享调用限制" class="sidebar-link">多指令共享调用限制</a></li></ul></li><li class="sidebar-sub-header"><a href="/guide/manage.html#按需加载与自动更新" class="sidebar-link">按需加载与自动更新</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/manage.html#观察者对象" class="sidebar-link">观察者对象</a></li><li class="sidebar-sub-header"><a href="/guide/manage.html#声明所需字段" class="sidebar-link">声明所需字段</a></li></ul></li></ul></li><li><a href="/guide/database.html" class="sidebar-link">使用数据库</a></li><li><a href="/guide/lifecycle.html" class="sidebar-link">事件与生命周期</a></li><li><a href="/guide/multiple-bots.html" class="sidebar-link">多账户与跨平台</a></li><li><a href="/guide/logger.html" class="sidebar-link">输出与日志</a></li><li><a href="/guide/unit-tests.html" class="sidebar-link">单元测试</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="用户状态管理"><a href="#用户状态管理" class="header-anchor">#</a> 用户状态管理</h1> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>本节所介绍的内容需要你安装一个数据库支持。如果你暂时不打算使用数据库，那么可以略过。</p></div> <p>在实际的机器人开发过程中，用户系统往往是必不可少的一环——它在展现机器人功能多样性的同时也避免了某个功能被滥用的情况。本章就来介绍 Koishi 内置的用户系统，以及用户数据是如何与指令调用相联系的。</p> <h2 id="用户系统"><a href="#用户系统" class="header-anchor">#</a> 用户系统</h2> <p>Koishi 内置了下面几个数据库字段：</p> <ul><li><strong>user:</strong> 用户表
<ul><li><strong>id:</strong> <code>number</code> 内部编号</li> <li><strong>???:</strong> <code>string</code> 平台编号</li> <li><strong>flag:</strong> <code>number</code> 状态标签</li> <li><strong>authority:</strong> <code>number</code> 用户权限</li> <li><strong>usage:</strong> <code>Record&lt;string, number&gt;</code> 指令调用次数</li> <li><strong>timers:</strong> <code>Record&lt;string, number&gt;</code> 指令调用时间</li></ul></li> <li><strong>channel:</strong> 频道表
<ul><li><strong>id:</strong> <code>string</code> 频道标识符</li> <li><strong>flag:</strong> <code>number</code> 状态标签</li> <li><strong>assignee:</strong> <code>string</code> 代理者</li></ul></li></ul> <p>下面我们将分别介绍它们。</p> <h3 id="状态标签"><a href="#状态标签" class="header-anchor">#</a> 状态标签</h3> <p>Koishi 使用<strong>状态标签</strong>来管理用户和群的可能状态。状态标签是一个正整数，它的每一个二进制位表示一种可能状态的开启或关闭。在 Koishi 中，这些状态通过一个枚举类型来进行辨别和修改。以下是内置的状态标签列表：</p> <ul><li><strong>User.Flag.ignore:</strong> 不响应用户的任何消息</li> <li><strong>Channel.Flag.ignore:</strong> 不响应频道内的任何消息</li> <li><strong>Channel.Flag.silent:</strong> 不主动向频道发送任何消息</li></ul> <p>利用位运算操作符，你可以用下面的方法辨别和修改状态信息：</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> { Channel } </span><span style="color:#F92672;">from</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">'koishi'</span></span>

<span class="line"><span style="color:#88846F;">// 判断会话用户是否被设置了 ignore 状态</span></span>
<span class="line"><span style="color:#F92672;">if</span><span style="color:#F8F8F2;"> (session.$group.flag </span><span style="color:#F92672;">&amp;</span><span style="color:#F8F8F2;"> Channel.Flag.ignore) {}</span></span>

<span class="line"><span style="color:#88846F;">// 为频道设置一个 ignore 状态</span></span>
<span class="line"><span style="color:#F8F8F2;">session.$group.flag </span><span style="color:#F92672;">|=</span><span style="color:#F8F8F2;"> Channel.Flag.ignore</span></span>

<span class="line"><span style="color:#88846F;">// 为频道取消一个 silent 状态</span></span>
<span class="line"><span style="color:#F8F8F2;">session.$group.flag </span><span style="color:#F92672;">&amp;=</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">~</span><span style="color:#F8F8F2;">Channel.Flag.silent</span></span></code></pre></div></div><h3 id="用户权限"><a href="#用户权限" class="header-anchor">#</a> 用户权限</h3> <p>Koishi 内部有一套默认的权限系统，它存储于用户数据的 <code>authority</code> 字段，并遵循下面的 <strong>核心规则</strong>：</p> <ul><li>数据库中没有的用户默认拥有 0 级权限</li> <li>高权限者能够执行一切低权限者的操作</li></ul> <p>当我们调用 <code>database.getUser()</code> 这样的原始接口向数据库请求用户资料时，如果该用户不存在，则会返回 <code>undefined</code>；但当我们调用 <code>session.getUser()</code> 这样的高级接口时，如果该用户不存在，则返回一个默认的 0 级用户对象而不是 <code>null</code>。这种特性能够尽可能减少用户存在性的判断代码——我们认为任何账号都是存在于数据库的，只不过有些是 0 级而已。</p> <p>在此基础上，我们还扩充出了这样的一套 <strong>设计准则</strong>：</p> <ul><li>0 级：不存在的用户</li> <li>1 级：所有用户，只能够接触有限的功能</li> <li>2 级：高级用户，能够接触几乎一切机器人的功能</li> <li>3 级：管理员，能够直接操作机器人事务</li> <li>4 级：高级管理员，能够管理其他账号</li></ul> <p>这套准则被用于 Koishi 的所有官方包的指令中，但是你也可以手动进行更改，扩展出你所需要的权限系统。稍后，我们将看到这些权限是如何被用于指令调用的。</p> <h3 id="平台相关字段"><a href="#平台相关字段" class="header-anchor">#</a> 平台相关字段</h3> <p>Koishi v3 起支持多平台和多账户，因此在用户系统中也需要记录相关的信息。</p> <p>用户数据中有一个可变字段，它记录了你在特定平台上的 <strong>用户编号</strong>。例如，如果你的 QQ 号的 111222333，Telegram 号为 444555666，那么你的用户数据可能长这样：</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F8F8F2;">{</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">&quot;id&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">233</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 请注意：即使 QQ 号都是数字，这个字段的值也永远是字符串</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">&quot;onebot&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&quot;111222333&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">&quot;telegram&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#E6DB74;">&quot;444555666&quot;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#E6DB74;">&quot;flag&quot;</span><span style="color:#F8F8F2;">: </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">...</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre></div></div><p>频道数据的 <code>id</code> 字段被称为 <strong>频道标识符</strong>，它由 <strong>平台名</strong> 和 <strong>频道编号</strong> 两部分组成，中间由冒号分隔。例如，一个群号为 123456789 的 QQ 群的频道标识符为 <code>onebot:123456789</code>。</p> <p>频道数据的 <code>assignee</code> 字段被称为 <strong>代理者</strong>，其中存储了负责该频道的机器人在对应平台的用户编号。当这个值与一个机器人无法匹配时，Koishi 会限制该机器人对该频道内信息的处理。这听起来可能有点奇怪，不过请想象一下当你的多个机器人同时加了一个频道时，一旦稍有不慎就可能导致这些机器人多次响应同一个输入，甚至可能导致循环触发等严重的后果。</p> <p>当然，即使机器人的用户编号与频道的代理者编号不匹配，通过 @ 机器人的方式调用指令仍然是安全的和被 Koishi 允许的。代理者机制可以确保 Koishi 管理的同源机器人中同时最多只有一个会响应来自其所在群的信息。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>上文所提到的 OneBot 是一个 QQ 机器人的协议，也是 Koishi 的早期版本的内置协议。</p> <p>扩展阅读：<a href="/guide/intro/faq.html#为什么其他平台的适配器名字都与平台一致，只有-qq-对应-onebot？">为什么其他平台的适配器名字都与平台一致，只有 QQ 对应 Onebot？</a></p></div> <h3 id="自动注册数据"><a href="#自动注册数据" class="header-anchor">#</a> 自动注册数据</h3> <p>前面已经介绍过了，默认情况下每一名用户都是 0 级权限，每一个群都没有代理者，这虽然安全但也给 Koishi 的搭建带来了不小的麻烦。因此，我们也提供了自动注册的配置项：<code>autoAuthorize</code> 和 <code>autoAssign</code>。下面展示两个例子：</p> <div class="panel-view code"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text">koishi.config.js</span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;">module</span><span style="color:#F8F8F2;">.</span><span style="color:#66D9EF;">exports</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 一旦收到来自未知频道的消息，就自动注册频道数据，代理者为收到消息的人</span></span>
<span class="line"><span style="color:#F8F8F2;">  autoAssign: </span><span style="color:#AE81FF;">true</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 一旦收到来自未知用户的消息，就自动注册用户数据，权限等级为 1</span></span>
<span class="line"><span style="color:#F8F8F2;">  autoAuthorize: </span><span style="color:#AE81FF;">1</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre></div></div><div class="panel-view code"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text">koishi.config.js</span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#66D9EF;">module</span><span style="color:#F8F8F2;">.</span><span style="color:#66D9EF;">exports</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 为频道 123456789 自动分配代理者</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#A6E22E;">autoAssign</span><span style="color:#F8F8F2;">: </span><span style="color:#FD971F;">ses</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;"> ses.channelId </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">'123456789'</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 为用户 987654321 设置 4 级权限</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 如果收到了来自未知用户的群消息，那么就自动注册用户数据，权限等级为 1</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#A6E22E;">autoAuthorize</span><span style="color:#F8F8F2;">: </span><span style="color:#FD971F;">ses</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;"> session.userId </span><span style="color:#F92672;">===</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">'987654321'</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">?</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">4</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">:</span><span style="color:#F8F8F2;"> ses.groupId </span><span style="color:#F92672;">?</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">1</span><span style="color:#F8F8F2;"> </span><span style="color:#F92672;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#AE81FF;">0</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span></code></pre></div></div><h2 id="指令调用管理"><a href="#指令调用管理" class="header-anchor">#</a> 指令调用管理</h2> <p>利用上面描述的这套用户系统，我们就可以实现指令的调用权限控制。本节将分别介绍目前支持的权限控制形式。通过配置 <code>ctx.command()</code> 的第二个参数可以修改有关指令调用的一些设置。</p> <p>下面的错误提示都是默认显示的，但是你也可以通过设置 <code>showWarning</code> 为 <code>false</code> 来手动关闭。关闭后，无论是以上哪种情况，机器人都将直接不响应调用，不会产生任何提示信息。</p> <h3 id="设置调用权限"><a href="#设置调用权限" class="header-anchor">#</a> 设置调用权限</h3> <p>你可以通过这样的方式设置一个指令的调用权限：</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">// 设置 echo 命令的调用权限为 2 级</span></span>
<span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">command</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'echo &lt;message:text&gt; 输出收到的信息'</span><span style="color:#F8F8F2;">, { authority: </span><span style="color:#AE81FF;">2</span><span style="color:#F8F8F2;"> })</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 设置 -t 选项的调用权限为 3 级</span></span>
<span class="line"><span style="color:#F8F8F2;">  .</span><span style="color:#A6E22E;">option</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'timeout'</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">'-t &lt;seconds&gt; 设定延迟发送的时间'</span><span style="color:#F8F8F2;">, { authority: </span><span style="color:#AE81FF;">3</span><span style="color:#F8F8F2;"> })</span></span></code></pre></div></div><p>这样一来，1 级或以下权限的用户就无法调用 echo 指令；2 级权限用户只能调用 echo 指令但不能使用 -t 参数；3 级或以上权限的用户不受限制。对于受限的用户，机器人将会回复“权限不足”。</p> <h3 id="设置访问次数上限"><a href="#设置访问次数上限" class="header-anchor">#</a> 设置访问次数上限</h3> <p>有些指令（例如签到抽卡点赞，高性能损耗的计算，限制次数的 API 调用等）我们并不希望被无限制调用，这时我们可以设置每天访问次数的上限：</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">// 设置 lottery 指令每人每天只能调用 10 次</span></span>
<span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">command</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'lottery 抽卡'</span><span style="color:#F8F8F2;">, { maxUsage: </span><span style="color:#AE81FF;">10</span><span style="color:#F8F8F2;"> })</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 设置使用了 -s 的调用不计入总次数</span></span>
<span class="line"><span style="color:#F8F8F2;">  .</span><span style="color:#A6E22E;">option</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'--show'</span><span style="color:#F8F8F2;">, </span><span style="color:#E6DB74;">'-s 查看已经抽到的物品列表'</span><span style="color:#F8F8F2;">, { notUsage: </span><span style="color:#AE81FF;">true</span><span style="color:#F8F8F2;"> })</span></span></code></pre></div></div><p>这样一来，所有访问 lottery 指令且不含 -s 选项的调用次数上限便被设成了 10 次。当超出总次数后，机器人将回复“调用次数已达上限”。</p> <h3 id="设置最短触发间隔"><a href="#设置最短触发间隔" class="header-anchor">#</a> 设置最短触发间隔</h3> <p>有些指令（例如高强度刷屏）我们并不希望被短时间内重复调用，这时我们可以设置最短触发间隔：</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> { Time } </span><span style="color:#F92672;">from</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">'koishi-core'</span></span>

<span class="line"><span style="color:#88846F;">// 设置 lottery 指令每 60 秒只能调用 1 次</span></span>
<span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">command</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'lottery'</span><span style="color:#F8F8F2;">, { minInterval: Time.minute })</span></span></code></pre></div></div><p>这样一来，lottery 指令被调用后 60 秒内，如果再次被调用，将会提示“调用过于频繁，请稍后再试”。当然，<code>notUsage</code> 对 <code>minInterval</code> 也同样生效。</p> <h3 id="多指令共享调用限制"><a href="#多指令共享调用限制" class="header-anchor">#</a> 多指令共享调用限制</h3> <p>如果我们希望让多个指令共同同一个调用限制，可以通过 <code>usageName</code> 来实现：</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">command</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'lottery 常驻抽卡'</span><span style="color:#F8F8F2;">, { maxUsage: </span><span style="color:#AE81FF;">10</span><span style="color:#F8F8F2;"> })</span></span>
<span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">command</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'accurate 精准抽卡'</span><span style="color:#F8F8F2;">, { maxUsage: </span><span style="color:#AE81FF;">10</span><span style="color:#F8F8F2;">, usageName: </span><span style="color:#E6DB74;">'lottery'</span><span style="color:#F8F8F2;"> })</span></span></code></pre></div></div><p>这样一来，就能限制每天的 lottery 和 accurate 指令的调用次数之和不超过 10 了。</p> <h2 id="按需加载与自动更新"><a href="#按需加载与自动更新" class="header-anchor">#</a> 按需加载与自动更新</h2> <p>上面介绍了一些 Koishi 内置的权限管理行为，而接下来将介绍的是开发者如何读取和更新数据。通常来说，中间件、插件的设计可以让机器人的开发变得更加模块化，但是这也带来了数据流向的问题。如果每个中间件分别从数据库中读取和更新自己所需的字段，那会造成大量重复的请求，导致严重的资源浪费；将所有可能请求的数据都在中间件的一开始就请求完成，并不会解决问题，因为一条信息的解读可能只需要少数几个字段，而大部分都是不需要的；更严重的是，后一种做法将导致资源单次请求，多次更新，从而产生种种数据安全性问题。那么针对这些问题，Koishi 又是如何解决的呢？</p> <h3 id="观察者对象"><a href="#观察者对象" class="header-anchor">#</a> 观察者对象</h3> <p>之前我们已经提到过，你可以在 <code>session.$user</code> 上获得本次事件相关的用户数据，但实际上 <code>session.$user</code> 能做的远远不止这些。它的本质其实是一个<strong>观察者</strong>对象。假如我们有下面的代码：</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">// 定义一个 items 字段，用于存放物品列表</span></span>
<span class="line"><span style="color:#F8F8F2;">User.</span><span style="color:#A6E22E;">extend</span><span style="color:#F8F8F2;">(() </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;"> ({ items: [] }))</span></span>

<span class="line"><span style="color:#F8F8F2;">ctx.</span><span style="color:#A6E22E;">command</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'lottery'</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">  .</span><span style="color:#A6E22E;">userFields</span><span style="color:#F8F8F2;">([</span><span style="color:#E6DB74;">'items'</span><span style="color:#F8F8F2;">])</span></span>
<span class="line"><span style="color:#F8F8F2;">  .</span><span style="color:#A6E22E;">action</span><span style="color:#F8F8F2;">(({ </span><span style="color:#FD971F;">session</span><span style="color:#F8F8F2;"> }) </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 这里假设 item 是一个字符串，表示抽到的物品</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#66D9EF;">const</span><span style="color:#F8F8F2;"> item </span><span style="color:#F92672;">=</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">getLotteryItem</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#88846F;">// 将抽到的物品存放到 user.items 中</span></span>
<span class="line"><span style="color:#F8F8F2;">    session.$user.items.</span><span style="color:#A6E22E;">push</span><span style="color:#F8F8F2;">(item)</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">`恭喜您获得了 </span><span style="color:#F92672;">${</span><span style="color:#F8F8F2;">item</span><span style="color:#F92672;">}</span><span style="color:#E6DB74;">！`</span></span>
<span class="line"><span style="color:#F8F8F2;">  })</span></span></code></pre></div></div><p>上面的代码看起来完全无法工作，因为我们都知道将数据写入数据库是一个异步的操作，但是在上面的中间件中我们没有调用任何异步操作。然而如果你运行这段代码，你会发现用户数据被成功地更新了。这就归功于观察者机制。<code>session.$user</code> 的本质是一个 <strong>观察者对象</strong>，它检测在其上面做的一切更改并缓存下来。当任务进行完毕后，Koishi 又会自动将变化的部分进行更新，同时将缓冲区清空。</p> <p>这套机制不仅可以将多次更新合并成一次以提高程序性能，更能解决数据竞争的问题。如果两条信息先后被接收到，如果单纯地使用 getUser / setUser 进行处理，可能会发生后一次 getUser 在前一次 setUser 之前完成，导致本应获得 2 件物品，但实际只获得了 1 件的问题。而观察者会随时同步同源数据，数据安全得以保证。</p> <p>当然，如果你确实需要阻塞式地等待数据写入，我们也提供了 <code>user._update()</code> 方法。顺便一提，一旦成功执行了观察者的 <code>_update()</code> 方法，之前的缓冲区将会被清空，因此之后不会重复更新数据；对于缓冲区为空的观察者，<code>_update()</code> 方法也会直接返回，不会产生任何的数据库访问。这些都是我们优化的几个细节。</p> <p>你可以在 <a href="/api/utils.html#observer-api">这里</a> 看到完整的观察者 API。</p> <h3 id="声明所需字段"><a href="#声明所需字段" class="header-anchor">#</a> 声明所需字段</h3> <p>如果说观察者机制帮我们解决了多次更新和数据安全的问题的话，那么这一节要介绍的就是如何控制要加载的内容。在上面的例子中我们看到了 <code>cmd.userFields()</code> 函数，它通过一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Iteration_protocols" target="_blank" rel="noopener noreferrer">可迭代对象<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 或者回调函数来添加所需的用户字段。同理我们也有 <code>cmd.channelFields()</code> 方法，功能类似。</p> <p>如果你需要对全体指令添加所需的用户字段，可以使用 <code>Command.userFields()</code>。下面是一个例子：</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#F92672;">import</span><span style="color:#F8F8F2;"> { Command } </span><span style="color:#F92672;">from</span><span style="color:#F8F8F2;"> </span><span style="color:#E6DB74;">'koishi-core'</span></span>

<span class="line"><span style="color:#88846F;">// 注意这不是实例方法，而是类上的静态方法</span></span>
<span class="line"><span style="color:#F8F8F2;">Command.</span><span style="color:#A6E22E;">userFields</span><span style="color:#F8F8F2;">([</span><span style="color:#E6DB74;">'name'</span><span style="color:#F8F8F2;">])</span></span>

<span class="line"><span style="color:#F8F8F2;">app.</span><span style="color:#A6E22E;">before</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'command'</span><span style="color:#F8F8F2;">, ({ </span><span style="color:#FD971F;">session</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;">command</span><span style="color:#F8F8F2;"> }) </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">  console.</span><span style="color:#A6E22E;">log</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'%s calls command %s'</span><span style="color:#F8F8F2;">, session.$user.name, command.name)</span></span>
<span class="line"><span style="color:#F8F8F2;">})</span></span></code></pre></div></div><p>如果要控制中间件能取得的用户数据，可以监听 before-user 和 before-channel 事件，通过修改传入的 <code>fields</code> 参数来添加特定的字段。下面是一个例子：</p> <div class="panel-view code mini"><div class="controls"><div class="circle red"></div> <div class="circle yellow"></div> <div class="circle green"></div> <div class="title"><span class="title-text"></span> <!----></div></div> <div class="content"><pre class="shiki" style="background-color:#272822;"><code><span class="line"><span style="color:#88846F;">// 定义一个 msgCount 字段，用于存放收到的信息数量</span></span>
<span class="line"><span style="color:#F8F8F2;">User.</span><span style="color:#A6E22E;">extend</span><span style="color:#F8F8F2;">(() </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;"> ({ msgCount: </span><span style="color:#E6DB74;">''</span><span style="color:#F8F8F2;"> }))</span></span>

<span class="line"><span style="color:#88846F;">// 手动添加要获取的字段，下面会介绍</span></span>
<span class="line"><span style="color:#F8F8F2;">app.</span><span style="color:#A6E22E;">before</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'attach-user'</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;">fields</span><span style="color:#F8F8F2;"> </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;"> fields.</span><span style="color:#A6E22E;">add</span><span style="color:#F8F8F2;">(</span><span style="color:#E6DB74;">'msgCount'</span><span style="color:#F8F8F2;">))</span></span>

<span class="line"><span style="color:#F8F8F2;">app.</span><span style="color:#A6E22E;">middleware</span><span style="color:#F8F8F2;">((</span><span style="color:#FD971F;">session</span><span style="color:#F8F8F2;">, </span><span style="color:#FD971F;">next</span><span style="color:#F8F8F2;">) </span><span style="color:#66D9EF;">=&gt;</span><span style="color:#F8F8F2;"> {</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#88846F;">// 这里更新了 msgCount 数据</span></span>
<span class="line"><span style="color:#F8F8F2;">  session.$user.msgCount</span><span style="color:#F92672;">++</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#F92672;">return</span><span style="color:#F8F8F2;"> </span><span style="color:#A6E22E;">next</span><span style="color:#F8F8F2;">()</span></span>
<span class="line"><span style="color:#F8F8F2;">})</span></span></code></pre></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/koishijs/koishijs.github.io/edit/docs/guide/manage.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">1/29/2021, 2:14:28 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/help.html" class="prev">
        查看和编写帮助
      </a></span> <span class="next"><a href="/guide/database.html">
        使用数据库
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.cd7094d9.js" defer></script><script src="/assets/js/2.9ff48064.js" defer></script><script src="/assets/js/9.4a353ef9.js" defer></script><script src="/assets/js/39.eee30141.js" defer></script><script src="/assets/js/5.1ec24116.js" defer></script>
  </body>
</html>
