(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{430:function(e,t,v){"use strict";v.r(t);var _=v(25),a=Object(_.a)({},(function(){var e=this,t=e.$createElement,v=e._self._c||t;return v("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[v("h1",{attrs:{id:"事件"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#事件"}},[e._v("#")]),e._v(" 事件 (Events)")]),e._v(" "),v("div",{staticClass:"custom-block danger"},[v("p",{staticClass:"custom-block-title"},[e._v("注意")]),e._v(" "),v("p",[e._v("这里是"),v("strong",[e._v("正在施工")]),e._v("的 koishi v3 的文档。要查看 v1 版本的文档，请前往"),v("RouterLink",{attrs:{to:"/v1/"}},[v("strong",[e._v("这里")])]),e._v("。")],1)]),e._v(" "),v("p",[e._v("建议配套阅读："),v("RouterLink",{attrs:{to:"/guide/lifecycle.html"}},[e._v("事件与生命周期")])],1),e._v(" "),v("h2",{attrs:{id:"上报事件"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#上报事件"}},[e._v("#")]),e._v(" 上报事件")]),e._v(" "),v("h3",{attrs:{id:"基本会话属性"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#基本会话属性"}},[e._v("#")]),e._v(" 基本会话属性")]),e._v(" "),v("p",[e._v("以下属性对所有会话都有：")]),e._v(" "),v("ul",[v("li",[v("strong",[e._v("type:")]),e._v(" "),v("code",[e._v("string")]),e._v(" 事件名称")]),e._v(" "),v("li",[v("strong",[e._v("subtype:")]),e._v(" "),v("code",[e._v("string")]),e._v(" 一级子事件名称")]),e._v(" "),v("li",[v("strong",[e._v("subsubtype:")]),e._v(" "),v("code",[e._v("string")]),e._v(" 二级子事件名称")]),e._v(" "),v("li",[v("strong",[e._v("platform:")]),e._v(" "),v("code",[e._v("string")]),e._v(" 产生事件的平台")]),e._v(" "),v("li",[v("strong",[e._v("selfId:")]),e._v(" "),v("code",[e._v("string")]),e._v(" 收到事件的机器人的平台 ID")]),e._v(" "),v("li",[v("strong",[e._v("userId:")]),e._v(" "),v("code",[e._v("string")]),e._v(" 触发事件的用户的平台 ID")]),e._v(" "),v("li",[v("strong",[e._v("groupId:")]),e._v(" "),v("code",[e._v("string")]),e._v(" 触发事件的群组的平台 ID")]),e._v(" "),v("li",[v("strong",[e._v("channelId:")]),e._v(" "),v("code",[e._v("string")]),e._v(" 触发事件的频道的平台 ID")]),e._v(" "),v("li",[v("strong",[e._v("timestamp:")]),e._v(" "),v("code",[e._v("number")]),e._v(" 收到事件的 UNIX 时间，单位为毫秒")])]),e._v(" "),v("h3",{attrs:{id:"消息类事件"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#消息类事件"}},[e._v("#")]),e._v(" 消息类事件")]),e._v(" "),v("p",[e._v("跟消息有关的几种事件统称为消息类事件，共有以下几种：")]),e._v(" "),v("ul",[v("li",[e._v("message: 收到新消息")]),e._v(" "),v("li",[e._v("message-deleted: 消息被删除")]),e._v(" "),v("li",[e._v("message-updated: 消息被修改")]),e._v(" "),v("li",[e._v("send: 机器人发出消息")])]),e._v(" "),v("p",[e._v("这些事件都还拥有以下的子事件：")]),e._v(" "),v("ul",[v("li",[e._v("private: 该消息是私聊消息")]),e._v(" "),v("li",[e._v("group: 该消息是群组消息")])]),e._v(" "),v("p",[e._v("与此类事件相关的属性有：")]),e._v(" "),v("ul",[v("li",[v("strong",[e._v("messageId:")]),e._v(" "),v("code",[e._v("string")]),e._v(" 消息 ID")]),e._v(" "),v("li",[v("strong",[e._v("content:")]),e._v(" "),v("code",[e._v("string")]),e._v(" 消息内容")]),e._v(" "),v("li",[v("strong",[e._v("author:")]),e._v(" 发送者信息\n"),v("ul",[v("li",[v("strong",[e._v("author.userId:")]),e._v(" "),v("code",[e._v("string")]),e._v(" 发送者的平台 ID")]),e._v(" "),v("li",[v("strong",[e._v("author.username:")]),e._v(" "),v("code",[e._v("string")]),e._v(" 发送者的平台昵称")]),e._v(" "),v("li",[v("strong",[e._v("author.nickname:")]),e._v(" "),v("code",[e._v("string")]),e._v(" 发送者在当前群组中的昵称")])])])]),e._v(" "),v("div",{staticClass:"custom-block tip"},[v("p",{staticClass:"custom-block-title"},[e._v("TIP")]),e._v(" "),v("p",[e._v("通常情况下 "),v("code",[e._v("author.userId")]),e._v(" 应该与 "),v("code",[e._v("userId")]),e._v(" 相同，但也有例外。如果是你发送的消息被管理员删除了，那么这两个字段就会是不同的了。")])]),e._v(" "),v("h3",{attrs:{id:"成员类事件"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#成员类事件"}},[e._v("#")]),e._v(" 成员类事件")]),e._v(" "),v("p",[e._v("跟群组、好友有关的事件统称为成员类事件，共有以下几种：")]),e._v(" "),v("ul",[v("li",[e._v("group-added: 加入了群组")]),e._v(" "),v("li",[e._v("group-deleted: 退出了群组")]),e._v(" "),v("li",[e._v("group-request: 收到了群组邀请")]),e._v(" "),v("li",[e._v("group-member-added: 群组成员增加")]),e._v(" "),v("li",[e._v("group-member-deleted: 群组成员减少")]),e._v(" "),v("li",[e._v("group-member-request: 收到了入群申请")]),e._v(" "),v("li",[e._v("friend-added: 好友数量增加")]),e._v(" "),v("li",[e._v("friend-deleted: 好友数量减少")]),e._v(" "),v("li",[e._v("friend-request: 收到了好友请求")])]),e._v(" "),v("p",[e._v("其中形如 group(-member)?-(added|deleted) 的事件都还拥有以下的子事件：")]),e._v(" "),v("ul",[v("li",[e._v("active: 该操作是由加入或退出方发起的")]),e._v(" "),v("li",[e._v("passive: 该操作是群组方发起的")])]),e._v(" "),v("p",[e._v("与此类事件相关的属性有：")]),e._v(" "),v("ul",[v("li",[v("strong",[e._v("operatorId:")]),e._v(" "),v("code",[e._v("string")]),e._v(" 操作者 ID")])]),e._v(" "),v("h3",{attrs:{id:"操作类事件"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#操作类事件"}},[e._v("#")]),e._v(" 操作类事件")]),e._v(" "),v("p",[e._v("上报事件中最主要的一部分都有着统一的结构："),v("strong",[e._v("事件主体")]),e._v(" + "),v("strong",[e._v("操作类型")]),e._v("。例如好友请求事件是 friend-request，群组文件更新事件是 group-file-updated 等。目前支持的事件主体包括以下几种：")]),e._v(" "),v("ul",[v("li",[e._v("friend")]),e._v(" "),v("li",[e._v("channel")]),e._v(" "),v("li",[e._v("group")]),e._v(" "),v("li",[e._v("group-member")]),e._v(" "),v("li",[e._v("group-role")]),e._v(" "),v("li",[e._v("group-file")]),e._v(" "),v("li",[e._v("group-emoji")])]),e._v(" "),v("p",[e._v("操作类型包含以下几种：")]),e._v(" "),v("ul",[v("li",[e._v("added")]),e._v(" "),v("li",[e._v("removed")]),e._v(" "),v("li",[e._v("deleted")])]),e._v(" "),v("p",[e._v("与此类事件相关的属性有：")]),e._v(" "),v("ul",[v("li",[e._v("TODO")])]),e._v(" "),v("h3",{attrs:{id:"群成员类事件"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#群成员类事件"}},[e._v("#")]),e._v(" 群成员类事件")]),e._v(" "),v("h3",{attrs:{id:"通知类事件"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#通知类事件"}},[e._v("#")]),e._v(" 通知类事件")]),e._v(" "),v("p",[e._v("由系统在频道中发送的各种通知构成了通知类事件，共有以下几种：")]),e._v(" "),v("ul",[v("li",[e._v("notice/poke: 戳一戳")]),e._v(" "),v("li",[e._v("notice/lucky-king: 运气王")]),e._v(" "),v("li",[e._v("notice/honor: 群荣誉")])]),e._v(" "),v("p",[e._v("与此类事件相关的属性有：")]),e._v(" "),v("ul",[v("li",[v("strong",[e._v("targetId:")]),e._v(" "),v("code",[e._v("string")]),e._v(" 戳一戳的目标用户 ID，运气王的获得者 ID")]),e._v(" "),v("li",[v("strong",[e._v("honorType:")]),e._v(" "),v("code",[e._v("string")]),e._v(" 荣誉类型，可能为 talkative, performer, emotion")])]),e._v(" "),v("h2",{attrs:{id:"内部事件"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#内部事件"}},[e._v("#")]),e._v(" 内部事件")]),e._v(" "),v("h3",{attrs:{id:"事件：before-connect"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#事件：before-connect"}},[e._v("#")]),e._v(" 事件：before-connect")]),e._v(" "),v("h3",{attrs:{id:"事件：connect"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#事件：connect"}},[e._v("#")]),e._v(" 事件：connect")]),e._v(" "),v("p",[e._v("开始 / 成功连接到服务器时在 App 实例触发。")]),e._v(" "),v("h3",{attrs:{id:"事件：before-attach-channel"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#事件：before-attach-channel"}},[e._v("#")]),e._v(" 事件：before-attach-channel")]),e._v(" "),v("h3",{attrs:{id:"事件：before-attach-user"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#事件：before-attach-user"}},[e._v("#")]),e._v(" 事件：before-attach-user")]),e._v(" "),v("p",[e._v("当 Koishi 试图从数据库获取频道 / 用户信息前触发。调用时会传入一个 "),v("code",[e._v("Set<string>")]),e._v(" 对象和一个 "),v("RouterLink",{attrs:{to:"/api/command.html"}},[v("code",[e._v("Argv")])]),e._v(" 对象。如果当前没有正在解析的指令，则该对象只会有一个 "),v("code",[e._v("session")]),e._v(" 属性。你可以在回调函数中修改传入的字段集合，增加的字段将可以被之后的中间件获取到。")],1),e._v(" "),v("p",[e._v("如果没有配置数据库，则两个事件都不会触发；如果不是群聊消息，则 before-attach-channel 事件不会触发。")]),e._v(" "),v("h3",{attrs:{id:"事件：attach-channel"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#事件：attach-channel"}},[e._v("#")]),e._v(" 事件：attach-channel")]),e._v(" "),v("h3",{attrs:{id:"事件：attach-user"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#事件：attach-user"}},[e._v("#")]),e._v(" 事件：attach-user")]),e._v(" "),v("p",[e._v("当 Koishi 完成频道 / 用户数据获取后触发。调用时会传入一个 Session 对象，将会拥有 "),v("code",[e._v("$channel")]),e._v("/"),v("code",[e._v("$user")]),e._v(" 属性。你可以在回调函数中对这两个属性做同步的修改（注意：只能是同步的修改）。这些修改会在后续过程中自动更新到数据库。")]),e._v(" "),v("p",[e._v("如果没有配置数据库，则两个事件都不会触发；如果不是群聊消息，则 attach-channel 事件不会触发。")]),e._v(" "),v("h3",{attrs:{id:"事件：before-send"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#事件：before-send"}},[e._v("#")]),e._v(" 事件：before-send")]),e._v(" "),v("p",[e._v("准备发送信息时会在对应的上下文触发。调用时会传入一个事件类型为 send 的 "),v("code",[e._v("Session")]),e._v(" 实例。")]),e._v(" "),v("h3",{attrs:{id:"事件：send"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#事件：send"}},[e._v("#")]),e._v(" 事件：send")]),e._v(" "),v("p",[e._v("成功发送信息时会在对应的上下文触发。调用时会传入一个 Meta 对象，比 "),v("code",[e._v("before-send")]),e._v(" 事件传入的对象多出一个 "),v("code",[e._v("messageId")]),e._v(" 属性。")]),e._v(" "),v("div",{staticClass:"custom-block tip"},[v("p",{staticClass:"custom-block-title"},[e._v("提示")]),e._v(" "),v("p",[e._v("注意只有非异步 Sender API 成功调用会触发此事件，而异步调用和快速回复都只会触发 "),v("code",[e._v("before-send")]),e._v(" 事件，因此你在实际使用中可能更需要上一个事件。")])]),e._v(" "),v("h3",{attrs:{id:"事件：before-command"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#事件：before-command"}},[e._v("#")]),e._v(" 事件：before-command")]),e._v(" "),v("p",[e._v("调用指令前会在对应的上下文触发。此时指令的可用性还未经检测，因此可能出现参数错误、权限不足、超过使用次数等情况。调用时传入一个 "),v("RouterLink",{attrs:{to:"/guide/command-system.html#parsedcommandline-对象"}},[v("code",[e._v("ParsedCommandLine")])]),e._v(" 对象。")],1),e._v(" "),v("h3",{attrs:{id:"事件：command"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#事件：command"}},[e._v("#")]),e._v(" 事件：command")]),e._v(" "),v("p",[e._v("执行指令的 "),v("code",[e._v("action")]),e._v(" 回调函数前会在对应的上下文触发。调用时传入一个 "),v("RouterLink",{attrs:{to:"/guide/command-system.html#parsedcommandline-对象"}},[v("code",[e._v("ParsedCommandLine")])]),e._v(" 对象。")],1),e._v(" "),v("h3",{attrs:{id:"事件：after-middleware"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#事件：after-middleware"}},[e._v("#")]),e._v(" 事件：after-middleware")]),e._v(" "),v("p",[e._v("在执行完全部中间件后会在对应的上下文触发。调用时传入一个 "),v("RouterLink",{attrs:{to:"/guide/message.html#深入-meta-对象"}},[v("code",[e._v("Meta")])]),e._v(" 对象。")],1),e._v(" "),v("h3",{attrs:{id:"事件：before-disconnect"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#事件：before-disconnect"}},[e._v("#")]),e._v(" 事件：before-disconnect")]),e._v(" "),v("p",[e._v("关闭服务器前在 App 实例触发。")]),e._v(" "),v("h3",{attrs:{id:"事件：disconnect"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#事件：disconnect"}},[e._v("#")]),e._v(" 事件：disconnect")]),e._v(" "),v("p",[e._v("成功关闭服务器时在 App 实例触发。")])])}),[],!1,null,null,null);t.default=a.exports}}]);