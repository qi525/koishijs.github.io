(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{428:function(t,s,a){"use strict";a.r(s);var l=a(25),c=Object(l.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"从旧版本迁移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#从旧版本迁移"}},[t._v("#")]),t._v(" 从旧版本迁移")]),t._v(" "),a("p",[t._v("这个页面将介绍 Koishi v3 的新特性和对应的迁移方法。")]),t._v(" "),a("h2",{attrs:{id:"包名变更"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#包名变更"}},[t._v("#")]),t._v(" 包名变更")]),t._v(" "),a("p",[t._v("koishi-database-mysql 变更为 koishi-plugin-mysql。")]),t._v(" "),a("p",[t._v("此外，你可能还需要额外安装 koishi-adapter-onebot 作为 QQ 平台的支持。")]),t._v(" "),a("h2",{attrs:{id:"钩子函数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#钩子函数"}},[t._v("#")]),t._v(" 钩子函数")]),t._v(" "),a("p",[t._v("Koishi v1 的 "),a("code",[t._v("ctx.receiver")]),t._v(" 使用了 "),a("a",{attrs:{href:"https://nodejs.org/api/events.html#events_class_eventemitter",target:"_blank",rel:"noopener noreferrer"}},[t._v("EventEmitter"),a("OutboundLink")],1),t._v(" 来分发事件，而 Koishi v3 则自己实现了一个事件系统。这样做将带来几点好处：")]),t._v(" "),a("ul",[a("li",[t._v("使用统一的事件分发机制，无需对每个上下文构造 EventEmitter 实例，具有更高的性能")]),t._v(" "),a("li",[a("code",[t._v("emit")]),t._v(", "),a("code",[t._v("parallel")]),t._v(", "),a("code",[t._v("bail")]),t._v(", "),a("code",[t._v("serial")]),t._v(" 等方法能够妥善处理不同场景下的事件回调")])]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("emit")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()      ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 同时触发，返回 void")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("parallel")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()  ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 同时触发，返回一个全部完成的 Promise")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("bail")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()      ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 依次触发，返回第一个 non-nullable 的结果")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("serial")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()    ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 依次触发，返回第一个 resolve non-nullable 的结果")])])])])]),a("p",[t._v("相关 API 的迁移方法如下：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.receiver.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("on")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(event, callback)    ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("on")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(event, callback)")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.receiver.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("emit")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(event, ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("args)   ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("emit")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(event, ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("args)")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("emitEvent")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("args)          ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("emit")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("args)")])])])])]),a("h2",{attrs:{id:"选择器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#选择器"}},[t._v("#")]),t._v(" 选择器")]),t._v(" "),a("p",[t._v("Koishi v3 提供了选择器，它完全覆盖了 v1 的上下文创建功能并有所增强。")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("user")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("123")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("456")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")                    ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("select")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'userId'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'123'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'456'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.groups.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("exclude")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("123")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("456")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")          ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("unselect")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'groupId'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'123'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'456'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.groups.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("intersect")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("user")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("789")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("))   ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("select")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'groupId'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(").")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("select")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'userId'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'789'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")])])])])]),a("p",[t._v("相关文档："),a("RouterLink",{attrs:{to:"/guide/context.html#使用选择器"}},[t._v("使用选择器")])],1),t._v(" "),a("h2",{attrs:{id:"会话接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#会话接口"}},[t._v("#")]),t._v(" 会话接口")]),t._v(" "),a("p",[t._v("Koishi v3 新增了会话的概念，它向下兼容大部分 Koishi v1 元信息对象的特性，并增加了大量方法：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.$app              ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// App 实例")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.$bot              ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// Bot 实例")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("send")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()            ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 发送消息")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("sendQueued")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()      ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 延时发送消息")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("cancelQueued")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()    ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 取消延时队列")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("middleware")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()      ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 注册仅对当前会话生效的中间件")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("prompt")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()          ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 等待一条消息")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("suggest")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()         ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 书写错误提示")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("resolve")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()         ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 解析 argv 对象")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("collect")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()         ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 获取指令所需字段")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("execute")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()         ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 执行指令")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("getUser")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()         ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 获取用户数据")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("getChannel")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()      ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 获取频道数据")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("observeUser")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()     ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 绑定可观测用户实例")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ses.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("observeChannel")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()  ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 绑定可观测频道实例")])])])])]),a("p",[t._v("相关文档："),a("RouterLink",{attrs:{to:"/guide/message.html#使用会话"}},[t._v("使用会话")])],1),t._v(" "),a("h2",{attrs:{id:"数据库变更"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库变更"}},[t._v("#")]),t._v(" 数据库变更")]),t._v(" "),a("p",[t._v("Koishi v3 的数据库相比 v1 发生了许多改动，最为显著的一点就是大部分 group 被替换为了 channel：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#A6E22E"}},[t._v("extendUser")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(callback)        ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  User.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("extend")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(callback)")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#A6E22E"}},[t._v("createUser")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(callback)        ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  User.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("create")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(callback)")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#A6E22E"}},[t._v("extendChannel")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(callback)     ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  Channel.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("extend")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(callback)")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#A6E22E"}},[t._v("createChannel")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(callback)     ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  Channel.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("create")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(callback)")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.db.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("getUser")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("args)     ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.db.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("getUser")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("args)")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("                            ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  session.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("getUser")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("args)")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.db.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("getGroup")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("args)    ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.db.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("getChannel")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("args)")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("                            ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  session.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("getChannel")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("...")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("args)")])])])])]),a("p",[t._v("同时由于 v3 的跨平台特性，你可能还需要留意 "),a("code",[t._v("database.getUser()")]),t._v(" 这个接口本身的变化。")]),t._v(" "),a("p",[t._v("相关文档："),a("RouterLink",{attrs:{to:"/guide/database.html"}},[t._v("使用数据库")])],1),t._v(" "),a("h2",{attrs:{id:"单一应用实例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#单一应用实例"}},[t._v("#")]),t._v(" 单一应用实例")]),t._v(" "),a("p",[t._v("Koishi v3 使用单一的 App 实例管理多个机器人账号，这将大幅提高程序的启动速度。")]),t._v(" "),a("p",[t._v("现在可以通过 "),a("code",[t._v("ctx.bots")]),t._v(" 访问当前 App 下的所有机器人，也可以用 "),a("code",[t._v("session.$app")]),t._v(" 和 "),a("code",[t._v("session.$bot")]),t._v(" 访问当前会话所在的 App 和 Bot 实例了。")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("appMap[selfId].sender       ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.bots[selfId]")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("appList.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("forEach")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(cb)         ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.bots.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("forEach")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(cb)")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.sender.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("sendGroupMsg")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()   ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.bots[selfId].")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("sendMessage")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("appMap[selfId]              ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  session.$app")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("appMap[selfId].sender       ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  session.$bot")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.sender.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("sendGroupMsg")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()   ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  session.$bot.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("sendMessage")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.selfId                  ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  bot.selfId")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#A6E22E"}},[t._v("getSelfIds")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()                ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  app.bots.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("map")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("bot")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" bot.selfId)")])])])])]),a("p",[t._v("同时我们也不再需要全局的生命周期方法了。直接使用 v1 就有的生命周期方法即可控制所有 Bot 实例。")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#A6E22E"}},[t._v("startAll")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()              ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("start")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#A6E22E"}},[t._v("stopAll")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()               ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("stop")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#A6E22E"}},[t._v("onStart")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(cb)             ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("on")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'connect'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", cb)")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#A6E22E"}},[t._v("onStop")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(cb)              ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("on")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'disconnect'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", cb)")])])])])]),a("p",[t._v("其他的构造选项变更：")]),t._v(" "),a("ul",[a("li",[t._v("commandPrefix -> prefix")]),t._v(" "),a("li",[t._v("maxMiddlewares -> maxListeners")]),t._v(" "),a("li",[t._v("defaultAuthority -> autoAuthorize")]),t._v(" "),a("li",[t._v("quickOperationTimeout -> onebot.quickOperation")])]),t._v(" "),a("h2",{attrs:{id:"指令选项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#指令选项"}},[t._v("#")]),t._v(" 指令选项")]),t._v(" "),a("p",[t._v("Koishi v1 的指令系统对 TypeScript 的类型标注并不友好。为了更好地适应强类型和按需获取数据的程序风格，Koishi v3 修改了指令选项的行为：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// v1")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("cmd.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("option")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'-f, --foo <arg>'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'description'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", { default: ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("123")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" })")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("cmd.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("option")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'-B, --no-bar'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'description'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("cmd.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("option")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'--baz <arg>'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'description'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", { isString: ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("true")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" })")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// v3")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("cmd.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("option")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'foo'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'-f <arg> description'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", { fallback: ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("123")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" })")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("cmd.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("option")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'bar'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'-B description'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", { value: ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("false")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" })")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("cmd.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("option")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'baz'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'<arg:string> description'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")])])])])]),a("p",[t._v("相关文档："),a("RouterLink",{attrs:{to:"/guide/command.html#定义选项"}},[t._v("定义选项")])],1),t._v(" "),a("h2",{attrs:{id:"事件名称"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#事件名称"}},[t._v("#")]),t._v(" 事件名称")]),t._v(" "),a("p",[t._v("为跨平台考虑，Koishi v3 调整了部分事件名称：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group-recall'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("            ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'message-deleted/group'")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'friend-recall'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("           ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'message-deleted/private'")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'friend-add'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("              ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'friend-added'")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group-increase'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("          ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group-added'")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("                          ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group-member-added'")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group-decrease'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("          ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group-deleted'")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("                          ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group-member-deleted'")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group-upload'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("            ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group-file-added'")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group-admin'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("             ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group-member/role'")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group-ban'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("               ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group-member/ban'")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'notify/*'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("                ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'notice/*'")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'request/friend'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("          ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'friend-request'")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'request/group/invite'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group-request'")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'request/group/add'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("       ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group-member-request'")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'heartbeat'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("               ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'lifecycle/heartbeat'")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'lifecycle/*'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("             ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'lifecycle/*'")])])])])])],1)}),[],!1,null,null,null);s.default=c.exports}}]);