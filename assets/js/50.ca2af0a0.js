(window.webpackJsonp=window.webpackJsonp||[]).push([[50],{405:function(t,a,s){"use strict";s.r(a);var l=s(25),o=Object(l.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"基本用法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本用法"}},[t._v("#")]),t._v(" 基本用法")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),s("p",[t._v("本章节将同时介绍 koishi-plugin-eval 和 koishi-plugin-eval-addons 两个插件，后者的功能将作为前者的补充。")])]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),s("p",[t._v("由于这两个插件使用了许多最新的特性。目前使用 koishi-plugin-eval 的功能需要你的 Node 版本不小于 14.6，并在运行时附上 "),s("code",[t._v("--enable-source-maps")]),t._v("。如果要使用 koishi-plugin-eval-addons，还需要额外附上 "),s("code",[t._v("--experimental-vm-modules")]),t._v(" 参数。")])]),t._v(" "),s("p",[t._v("koishi-plugin-eval 允许用户直接使用机器人执行脚本。它利用了 Node.js 的 vm 和 worker_thread 模块，在保护执行安全的前提下能够获得较快的响应速度。同时，插件还提供了一些内置的 API 供用户调用，结合教学功能可以在客户端实现复杂的行为。")]),t._v(" "),s("p",[t._v("koishi-plugin-eval-addons 在前一个插件的基础上，允许用户编写自己的模块并永久保存。插件将自动加载特定目录下的文件，并将其作为机器人的内置功能。用户可以利用此功能存储较为复杂的代码，甚至扩展新的指令。同时，如果上述目录是一个 git 目录，该插件也提供了自动更新等机制。")]),t._v(" "),s("h2",{attrs:{id:"安全性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安全性"}},[t._v("#")]),t._v(" 安全性")]),t._v(" "),s("h3",{attrs:{id:"使用陷阱"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用陷阱"}},[t._v("#")]),t._v(" 使用陷阱")]),t._v(" "),s("p",[t._v("koishi-plugin-eval 提供了一套陷阱 API。它会影响 evaluate 指令和扩展指令中的用户数据。你可以通过下面的方式来定义一个陷阱：")]),t._v(" "),s("panel-view",{staticClass:"code",attrs:{title:""}},[s("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[s("code",[s("span",{staticClass:"line"},[s("span",{staticStyle:{color:"#F92672"}},[t._v("import")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" { userTrap } ")]),s("span",{staticStyle:{color:"#F92672"}},[t._v("from")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-plugin-eval'")])]),t._v("\n\n"),s("span",{staticClass:"line"},[s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("userTrap.")]),s("span",{staticStyle:{color:"#A6E22E"}},[t._v("define")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'foo'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", {")])]),t._v("\n"),s("span",{staticClass:"line"},[s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  fields: [")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'bar'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("],")])]),t._v("\n"),s("span",{staticClass:"line"},[s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),s("span",{staticStyle:{color:"#A6E22E"}},[t._v("get")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(": ")]),s("span",{staticStyle:{color:"#FD971F"}},[t._v("user")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),s("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" user.bar,")])]),t._v("\n"),s("span",{staticClass:"line"},[s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),s("span",{staticStyle:{color:"#A6E22E"}},[t._v("set")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(": (")]),s("span",{staticStyle:{color:"#FD971F"}},[t._v("user")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),s("span",{staticStyle:{color:"#FD971F"}},[t._v("value")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),s("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" user.bar ")]),s("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" value,")])]),t._v("\n"),s("span",{staticClass:"line"},[s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("})")])])])])]),s("p",[t._v("这样一来，当用户在沙箱中尝试访问 "),s("code",[t._v("user.foo")]),t._v(" 时，访问到的实际上是 "),s("code",[t._v("user.bar")]),t._v(" 的数据。")]),t._v(" "),s("p",[t._v("当然，陷阱 API 能做的事远比上面的例子强大。假如一些数据的计算更适合在主线程完成，你就可以通过陷阱来将已经计算好的数据暴露给子线程。")]),t._v(" "),s("h3",{attrs:{id:"禁用部分指令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#禁用部分指令"}},[t._v("#")]),t._v(" 禁用部分指令")]),t._v(" "),s("p",[t._v("如果你担心在 evaluate 中调用部分指令存在风险，你可以手动将这些指令设置为禁止在沙箱中调用：")]),t._v(" "),s("panel-view",{staticClass:"code",attrs:{title:""}},[s("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[s("code",[s("span",{staticClass:"line"},[s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),s("span",{staticStyle:{color:"#A6E22E"}},[t._v("command")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),s("span",{staticStyle:{color:"#E6DB74"}},[t._v("'foo'")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", { noEval: ")]),s("span",{staticStyle:{color:"#AE81FF"}},[t._v("true")]),s("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" })")])])])])]),s("panel-view",{attrs:{title:"聊天记录"}},[s("chat-message",{attrs:{nickname:"Alice",color:"#cc0066"}},[t._v("> exec('foo')")]),t._v(" "),s("chat-message",{attrs:{nickname:"Koishi",avatar:"/koishi.png"}},[t._v("不能在 evaluate 指令中调用 foo 指令。")])],1),t._v(" "),s("p",[t._v("默认情况下，evaluate 指令本身也是禁止在沙箱中调用的。")])],1)}),[],!1,null,null,null);a.default=o.exports}}]);