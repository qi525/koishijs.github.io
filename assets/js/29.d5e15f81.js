(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{424:function(t,s,a){"use strict";a.r(s);var l=a(25),c=Object(l.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"插件与上下文"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#插件与上下文"}},[t._v("#")]),t._v(" 插件与上下文")]),t._v(" "),a("h2",{attrs:{id:"使用插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用插件"}},[t._v("#")]),t._v(" 使用插件")]),t._v(" "),a("p",[t._v("Koishi 官方实现了许多功能，但一个机器人很可能只会用到其中的一部分。因此我们采用了插件化的方式，将不同的功能解耦到了不同的包中。你可以在 "),a("RouterLink",{attrs:{to:"/plugins/"}},[t._v("官方插件")]),t._v(" 中了解到各种不同的功能。")],1),t._v(" "),a("h3",{attrs:{id:"安装插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装插件"}},[t._v("#")]),t._v(" 安装插件")]),t._v(" "),a("p",[t._v("在之前的文档中，我们已经展示了如何通过配置文件和脚本调用两种方法使用插件，它们的写法略有不同。让我们先回顾一下：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:"koishi.config.js"}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  plugins: {")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'./my-plugin'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(": ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("true")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// true 和 {} 的效果等价")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'common'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(": { ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("/* 传给 koishi-plugin-common 的选项 */")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" },")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")])])])])]),a("p",[a("code",[t._v("plugins")]),t._v(" 是一个对象，其中的每一个键表示一个插件的路径。")]),t._v(" "),a("ul",[a("li",[t._v("如果是一个绝对路径或者相对路径，我们会相对 koishi.config.js 所在的目录进行解析")]),t._v(" "),a("li",[t._v("其他情况下我们将其视为包名，并允许省略 koishi-plugin- 这个前缀，并考虑 scope 带来的影响（例如对于 foo/bar，我们将尝试读取 koishi-plugin-foo/bar 和 foo/bar 两个包；对于 @foo/bar，我们将尝试读取 @foo/koishi-plugin-bar 和 @foo/bar 两个包）")])]),t._v(" "),a("p",[t._v("上面的写法使用 API 可以写成：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:"index.js"}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  .")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'./my-plugin'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("))")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  .")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-plugin-common'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("), options)")])])])])]),a("h3",{attrs:{id:"开发插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#开发插件"}},[t._v("#")]),t._v(" 开发插件")]),t._v(" "),a("p",[t._v("一个"),a("strong",[t._v("插件")]),t._v("的本质是以下两个之一：")]),t._v(" "),a("ul",[a("li",[t._v("一个接受两个参数的函数，第一个参数是所在的上下文，第二个参数是传入的选项")]),t._v(" "),a("li",[t._v("一个对象，其中的 "),a("code",[t._v("apply")]),t._v(" 方法是上面所说的函数")])]),t._v(" "),a("p",[t._v("因此，下面的三种写法是等价的：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("middleware")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(callback)")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("ctx")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("middleware")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(callback))")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("({")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("apply")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(": ")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("ctx")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("middleware")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(callback),")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("})")])])])])]),a("p",[t._v("插件化的写法能够帮助我们将多个逻辑组合在一起并模块化，同时可以在插件内部对所需的选项进行初始化，这些都能极大地提高了代码的可维护性。这是因为每个人都可以直接将代码以插件的形式导出成模块，之后插件名又可以被直接写在 "),a("code",[t._v("koishi.config.js")]),t._v(" 文件中。")]),t._v(" "),a("h3",{attrs:{id:"具名插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#具名插件"}},[t._v("#")]),t._v(" 具名插件")]),t._v(" "),a("p",[t._v("除此以外，插件如果使用对象式，那么除了 "),a("code",[t._v("apply")]),t._v(" 以外，你还可以提供一个 "),a("code",[t._v("name")]),t._v(" 属性。如果提供了这个属性，命令行工具会将这个名字输出到控制台中。例如，下面给出了一个插件的例子，它实现了检测说话带空格的功能：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:"detect-space.js"}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".name ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'detect-space'")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("apply")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("ctx")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("middleware")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("((")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("meta")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("next")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("if")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (meta.message.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("match")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("/")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("^")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("\\s")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("*")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("(")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("\\S")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("+")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v(")")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("{2,}")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("\\S\\s")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("*$")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("/")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("g")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")) {")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("return")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" meta.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("send")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'在？为什么说话带空格？'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    } ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("else")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("      ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("return")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("next")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("()")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    }")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  })")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")])])])])]),a("p",[t._v("把它放到你的机器人文件夹，接着向你的 "),a("code",[t._v("koishi.config.js")]),t._v(" 添加一行：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:"koishi.config.js"}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  plugins: {")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("    ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'./detect-space'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(": ")]),a("span",{staticStyle:{color:"#AE81FF"}},[t._v("true")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(",")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  },")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")])])])])]),a("p",[t._v("调用 "),a("code",[t._v("koishi start")]),t._v("，你就可以看到这个插件在正常运行的提示了。")]),t._v(" "),a("h3",{attrs:{id:"嵌套插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#嵌套插件"}},[t._v("#")]),t._v(" 嵌套插件")]),t._v(" "),a("p",[t._v("Koishi 的插件也是可以嵌套的。你可以将你编写的插件解耦成多个独立的子插件，再用一个父插件作为入口，就像这样：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:"koishi-plugin-foo/index.js"}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// 在 a.js, b.js 中编写两个不同的插件")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("const")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" pluginA ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'./a'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("const")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" pluginB ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'./b'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// 将这两个插件输出")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".pluginA ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" pluginA")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".pluginB ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" pluginB")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// 在 apply 函数中安装 a, b 两个插件")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#66D9EF"}},[t._v("module")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("exports")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(".")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("apply")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("=")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" (")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("ctx")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" {")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(pluginA)")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("  ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(pluginB)")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("}")])])])])]),a("p",[t._v("这样别人就可以这样使用你的插件了：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// 如果希望同时使用你的插件的全部功能")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-plugin-foo'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("))")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// 如果只希望启用一部分功能")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-plugin-foo'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(").pluginA)")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// 或者等价的写法")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'koishi-plugin-foo/a'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("))")])])])])]),a("p",[t._v("Koishi 的官方插件 koishi-plugin-common 也使用了 "),a("a",{attrs:{href:"https://github.com/koishijs/koishi/blob/master/packages/plugin-common/src/index.ts",target:"_blank",rel:"noopener noreferrer"}},[t._v("这种写法"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"使用上下文"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用上下文"}},[t._v("#")]),t._v(" 使用上下文")]),t._v(" "),a("p",[t._v("一个 "),a("strong",[t._v("上下文")]),t._v(" 描述了机器人的一种可能的运行环境。例如，如果一个指令或中间件被绑定在了上面例子中的上下文，那么只有该环境下的事件才会触发对应的回调函数。之前介绍过的 "),a("code",[t._v("ctx.on()")]),t._v(", "),a("code",[t._v("ctx.middleware()")]),t._v(" 以及 "),a("code",[t._v("ctx.plugin()")]),t._v(" 这些 API 都是上下文类所提供的方法，而我们能在 "),a("code",[t._v("app")]),t._v(" 上调用这些方法只是因为 "),a("code",[t._v("App")]),t._v(" 对象本身也是一个上下文而已。")]),t._v(" "),a("h3",{attrs:{id:"使用选择器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用选择器"}},[t._v("#")]),t._v(" 使用选择器")]),t._v(" "),a("p",[t._v("我们可以通过 "),a("strong",[t._v("选择器")]),t._v(" 来快速创建新的上下文：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("group")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("() ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 选择全部群聊会话")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.group.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("except")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("() ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 选择全部私聊会话")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("group")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'112233'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 选择来自群 112233 的会话")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.group.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("except")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'112233'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 选择来自除了群 112233 以外的群的会话")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("user")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'445566'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 选择来自用户 445566 的会话（包括群聊和私聊）")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.group.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("except")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("().")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("user")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'445566'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(") ")]),a("span",{staticStyle:{color:"#88846F"}},[t._v("// 选择来自用户 445566 的私聊会话")])])])])]),a("p",[t._v("它们实际上是 "),a("code",[t._v("ctx.select()")]),t._v(" 和 "),a("code",[t._v("ctx.unselect()")]),t._v(" 方法的语法糖。对于上面的最后一个例子，你可以等价地表示成：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// 选择来自用户 445566 的私聊会话")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("unselect")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'groupId'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(").")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("select")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'userId'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'445566'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")])])])])]),a("p",[t._v("利用上下文，你可以非常方便地对每个环境进行分别配置：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// 在所有环境注册中间件")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("middleware")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(callback)")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// 当有人申请加群 112233 时触发 listener")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("group")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'112233'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(").")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("on")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'group-request'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", listener)")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// 注册指令 my-command，有数据库支持时才生效")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("select")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'database'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(").")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("command")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'my-command'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// 安装插件 ./my-plugin，仅限 OneBot 平台使用")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("select")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'platform'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'onebot'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(").")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("plugin")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("require")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'./my-plugin'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("))")])])])])]),a("p",[t._v("是不是非常方便呢？")]),t._v(" "),a("h3",{attrs:{id:"使用过滤器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用过滤器"}},[t._v("#")]),t._v(" 使用过滤器")]),t._v(" "),a("p",[t._v("你也可以自定义一个上下文的 "),a("strong",[t._v("过滤器")]),t._v(" 函数：它传入一个会话对象，并返回一个 boolean 类型。")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// 满足当前上下文条件，且消息内容为“啦啦啦”")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("intersect")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("session")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" session.content ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("===")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'啦啦啦'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// 满足当前上下文条件，或消息内容为“啦啦啦”")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("ctx.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("union")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#FD971F"}},[t._v("session")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#66D9EF"}},[t._v("=>")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" session.content ")]),a("span",{staticStyle:{color:"#F92672"}},[t._v("===")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(" ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'啦啦啦'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(")")])])])])]),a("p",[t._v("这里的两个方法 "),a("code",[t._v("ctx.intersect()")]),t._v(" 和 "),a("code",[t._v("ctx.union()")]),t._v(" 也可以传入一个上下文，表示两个上下文的交集和并集：")]),t._v(" "),a("panel-view",{staticClass:"code",attrs:{title:""}},[a("pre",{staticClass:"shiki",staticStyle:{"background-color":"#272822"}},[a("code",[a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// 选择来自用户 445566 的私聊会话")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("unselect")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'groupId'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(").")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("intersect")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("select")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'userId'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'445566'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("))")])]),t._v("\n\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#88846F"}},[t._v("// 选择来自用户 445566 的会话，以及全部私聊会话")])]),t._v("\n"),a("span",{staticClass:"line"},[a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("unselect")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'groupId'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(").")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("union")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(app.")]),a("span",{staticStyle:{color:"#A6E22E"}},[t._v("select")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("(")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'userId'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v(", ")]),a("span",{staticStyle:{color:"#E6DB74"}},[t._v("'445566'")]),a("span",{staticStyle:{color:"#F8F8F2"}},[t._v("))")])])])])]),a("p",[t._v("这些方法会返回一个新的上下文，在其上使用监听器、中间件、指令或是插件就好像同时在多个上下文中使用一样。")])],1)}),[],!1,null,null,null);s.default=c.exports}}]);